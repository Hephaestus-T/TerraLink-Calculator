<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TerraLink Affordability Wizard</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --navy:      #1e2d5c;
      --green:     #2c9c7a;
      --red:       #d9534f;
      --yellow:    #f0ad4e;
      --bg-gray:   #f7f9fc;
      --text-dark: #333;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; padding:20px;
      background: var(--bg-gray);
      color: var(--navy);
      font-family: Lato, sans-serif;
    }
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 40px;
    }
    .wizard { max-width: 960px; margin: 0 auto; overflow: hidden; }

    .wizard-progress { display:flex; margin-bottom:40px; }
    .wizard-step {
      flex:1; text-align:center; padding:12px 0;
      font-family:'Playfair Display', serif;
      font-size:1.1rem; color:var(--text-dark);
      cursor:pointer; position:relative; transition:color .3s;
    }
    .wizard-step.active {
      color:var(--navy); font-weight:700;
    }
    .wizard-step.active::after {
      content:''; position:absolute;
      bottom:0; left:20%; right:20%;
      height:3px; background:var(--green);
      border-radius:2px;
    }

    .wizard-panels {
      display:flex; width:400%; transition:transform .5s ease;
    }
    .panel { flex:1; padding:50px 30px; }

    .card {
      background:#fff; border-radius:14px;
      /* increased padding & luxe shadow */
      padding:32px; margin-bottom:36px;
      box-shadow:0 8px 24px rgba(0,0,0,0.08);
    }
    .section-title {
      font-family:'Playfair Display', serif;
      font-size:1.6rem; color:var(--navy);
      margin-bottom:24px;
      border-bottom:2px solid var(--green);
      padding-bottom:8px;
    }

    .form-row {
      display:flex; flex-wrap:wrap; align-items:center;
      margin-bottom:20px;
    }
    .form-row label {
      width:140px; min-width:120px;
      font-weight:600; color:var(--text-dark);
    }
    .form-row input,
    .form-row select {
      flex:1; padding:10px 8px;
      border:none; border-bottom:2px solid #ccc;
      transition:border-color .3s,box-shadow .3s;
      /* prevent iOS zoom: at least 16px */
      font-size:1rem;
      line-height:1.4;
    }
    .form-row input:focus,
    .form-row select:focus {
      outline:none;
      border-bottom-color:var(--green);
      box-shadow:0 2px 6px rgba(44,156,122,0.3);
    }
    .form-row select {
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      background: var(--bg-gray);
      border:1px solid #ccc; border-radius:8px;
      padding:14px 16px; margin:8px 0 24px;
      font-size:1rem;
      color:var(--navy);
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.1);
      transition:border-color .25s,box-shadow .25s;
    }
    .form-row select:hover {
      border-color:var(--green);
      box-shadow: inset 0 2px 6px rgba(44,156,122,0.2);
    }

    .btn {
      display:inline-block; padding:12px 20px;
      border:none; border-radius:8px;
      font-size:1rem; font-weight:600;
      cursor:pointer; margin-top:24px;
      transition:background .3s,transform .2s;
    }
    .btn-gold { background:var(--green); color:#fff; }
    .btn-gold:hover { transform:translateY(-2px); }
    .btn-navy { background:var(--navy); color:#fff; margin-left:16px; }
    .btn-navy:hover { transform:translateY(-2px); }

    .monthly-display {
      margin-left:auto; font-weight:700;
      font-size:1.15rem; color:var(--green);
    }
    #total-income {
      font-size:3rem; color:var(--green);
      font-weight:700; margin-top:8px;
    }

    .expense-total-row {
      margin-top:16px; border-top:1px dashed #ddd;
      padding-top:16px;
    }
    #total-expenses {
      margin-left:auto; font-weight:700;
      font-size:3rem; color:var(--red);
    }

    /* Summary panel */
    #equation {
      display:flex; flex-direction:column;
      align-items:center; gap:16px;
      margin:32px 0;
    }
    #equation .eq-row {
      display:flex; justify-content:space-between;
      width:80%; font-size:1.6rem; line-height:1.2;
      /* extra breathing room */
      margin-bottom:2rem;
    }
    #equation .eq-row:last-child {
      margin-bottom:0;
    }
    .eq-row span:last-child { font-weight:700; }

    /* warning if under $600 */
    #budget-health {
      font-size:1.2rem;
      color: var(--red);
      text-align:center;
      margin-bottom:16px;
    }

    .btn-copy {
      display:inline-block; margin:0 auto 32px;
      padding:10px 18px;
      border:2px solid var(--navy);
      border-radius:6px;
      background:#fff; color:var(--navy);
      font-size:1rem; font-weight:600;
      cursor:pointer;
      transition:background .3s,color .3s,transform .2s;
    }
    .btn-copy:hover {
      background:var(--navy); color:#fff;
      transform:translateY(-2px);
    }

    .btn-row {
      display:flex; justify-content:space-between;
      margin-top:30px;
    }

    #chart-container { display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:24px; margin-top:40px; }
    #breakdown-chart { width:240px; height:240px; }
    #chart-legend { list-style:none; padding:0; margin:0; }
    #chart-legend li { display:flex; align-items:center; margin-bottom:10px; }
    .dot { width:14px; height:14px; border-radius:50%; display:inline-block; margin-right:10px; }
    #affordability-explanation p { margin:12px 0; font-size:1.4rem; line-height:1.4; }
    #affordability-explanation .rent     { color:var(--red);   }
    #affordability-explanation .toward   { color:var(--yellow); }
    #affordability-explanation .leftover { color:var(--green); }
    .shortfall { color: var(--red); font-weight:600; }
    #affordability-result { font-size:1.4rem; margin-top:24px; }

    /* --------------------------- */
    /* RESPONSIVE BREAKPOINT RULES */
    /* --------------------------- */
    @media (max-width: 480px) {
      .wizard-progress { display: none; }
      .form-row {
        flex-direction: column;
        align-items: stretch;
      }
      .form-row label {
        width: auto;
        margin-bottom: 6px;
      }
      .form-row input,
      .form-row select {
        width: 100%;
      }
      .btn-row {
        flex-direction: column;
        gap: 12px;
      }
      .btn-row .btn {
        width: 100%;
      }
      #equation {
        gap: 8px;
        margin: 24px 0;
      }
      .eq-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        font-size: 1.3rem;
      }
      .eq-row span:last-child {
        font-size: 1.6rem;
      }
    }
    @media (min-width: 481px) and (max-width: 768px) {
      .form-row {
        flex-direction: row;
        align-items: center;
      }
      .form-row label {
        width: 140px;
        margin-bottom: 0;
      }
      .btn-row {
        gap: 16px;
      }
    }
    @media (min-width: 769px) {
      body {
        padding: 40px;
      }
      h1 {
        font-size: 3rem;
      }
    }
  </style>
</head>
<body>
  <div class="wizard">
    <h1>Find Your Path to Homeownership</h1>

    <div class="wizard-progress">
      <div class="wizard-step" data-step="0">1. Income</div>
      <div class="wizard-step" data-step="1">2. Expenses</div>
      <div class="wizard-step" data-step="2">3. Summary</div>
      <div class="wizard-step" data-step="3">4. Mortgage</div>
    </div>

    <div class="wizard-panels">

      <!-- STEP 1: Income -->
      <section class="panel">
        <div class="section-title">Let‚Äôs figure out your monthly income</div>
        <div id="employers-container"></div>
        <button class="btn btn-gold" id="add-employer-btn">+ Add Employer</button>
        <div class="section-title">Other Income</div>
        <div id="other-income-container"></div>
        <button class="btn btn-gold" id="add-other-income-btn">+ Add Income</button>
        <div class="form-row">
          <label>Total Monthly Income:</label>
          <div id="total-income">$0.00</div>
        </div>
        <button class="btn btn-gold next-btn">Next ‚Üí</button>
      </section>

      <!-- STEP 2: Expenses -->
      <section class="panel">
        <div class="section-title">Let‚Äôs figure out your monthly expenses</div>
        <div id="expenses-container"></div>
        <button class="btn btn-gold" id="add-expense-btn">+ Add Expense</button>
        <div id="expense-selector" class="form-row" style="display:none;">
          <select id="expense-type-select">
            <option value="car">Car Payment</option>
            <option value="credit">Credit Card</option>
            <option value="loan">Loan</option>
            <option value="child-support">Child Support</option>
            <option value="medical-bills">Medical Bills</option>
          </select>
          <button class="btn btn-navy" id="expense-type-confirm-btn">Add</button>
        </div>
        <div class="expense-total-row form-row">
          <label>Total Monthly Expenses:</label>
          <div id="total-expenses">$0.00</div>
        </div>
        <button class="btn prev-btn">‚Üê Back</button>
        <button class="btn btn-gold next-btn">Next ‚Üí</button>
      </section>

      <!-- STEP 3: Summary -->
      <section class="panel">
        <div class="section-title">Your Disposable Income</div>
        <div id="equation">
          <div class="eq-row"><span>Monthly Income</span><span id="eq-income">$0.00</span></div>
          <div class="eq-row"><span>‚Äì Monthly Expenses</span><span id="eq-exp">$0.00</span></div>
          <div class="eq-row"><span>= Disposable Income</span><span id="eq-disp">$0.00</span></div>
        </div>
        <div id="budget-health"></div>
        <button id="copy-btn" class="btn-copy">üìã Copy for reference</button>
        <div class="btn-row">
          <button class="btn prev-btn">‚Üê Back</button>
          <button class="btn btn-gold next-btn">Next ‚Üí</button>
        </div>
      </section>

      <!-- STEP 4: Mortgage -->
      <section class="panel">
        <div class="section-title">Do you have a target mortgage payment?</div>
        <div class="form-row">
          <label>Desired Mortgage:</label>
          <input type="number" id="mortgage-input" placeholder="$ / mo" min="0" step="0.01">
        </div>
        <button class="btn btn-navy" id="check-afford-btn">Check</button>

        <div id="chart-container">
          <canvas id="breakdown-chart" width="240" height="240"></canvas>
          <ul id="chart-legend"></ul>
        </div>
        <div id="affordability-explanation"></div>
        <div id="affordability-result"></div>
        <button class="btn prev-btn">‚Üê Back</button>
      </section>

    </div>
  </div>

  <script>
    function fmt(n) {
      return n.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
    const varGet = n => getComputedStyle(document.documentElement).getPropertyValue(n).trim();

    document.addEventListener('DOMContentLoaded', () => {
      const steps = [...document.querySelectorAll('.wizard-step')],
            panels = document.querySelector('.wizard-panels');
      let cur = 0;

      function show(i) {
        cur = i;
        panels.style.transform = `translateX(-${(i * 100) / steps.length}%)`;
        steps.forEach((s, j) => s.classList.toggle('active', j === i));
        // Jump instantly to top of wizard
        document.querySelector('.wizard').scrollIntoView({ block: 'start' });
      }

      steps.forEach(s => s.onclick = () => show(+s.dataset.step));
      show(0);
      document.querySelectorAll('.next-btn').forEach(b => b.onclick = () => show(Math.min(cur + 1, 3)));
      document.querySelectorAll('.prev-btn').forEach(b => b.onclick = () => show(Math.max(cur - 1, 0)));

      let emp = 0, oth = 0, maxE = 4;
      const empC = document.getElementById('employers-container'),
            addE = document.getElementById('add-employer-btn'),
            othC = document.getElementById('other-income-container'),
            addO = document.getElementById('add-other-income-btn');

      // Per-card pay-type toggle
      addE.onclick = () => {
        if (emp >= maxE) return;
        emp++;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="section-title">Employer ${emp}</div>
          <div class="form-row">
            <label>Pay Type:</label>
            <select class="pay-type-select">
              <option value="hourly" selected>Hourly</option>
              <option value="salary">Yearly Salary</option>
            </select>
          </div>
          <div class="hourly-group">
            <div class="form-row">
              <label>Hourly Rate ($):</label>
              <input type="number" class="hourly-rate" min="0" step="0.01">
            </div>
            <div class="form-row">
              <label>Hours/Week:</label>
              <input type="number" class="hours-per-week" min="0" step="0.1">
            </div>
          </div>
          <div class="salary-group" style="display:none;">
            <div class="form-row">
              <label>Yearly Salary ($):</label>
              <input type="number" class="yearly-salary" min="0" step="0.01">
            </div>
          </div>
          <div class="form-row">
            <label>Monthly Income:</label>
            <span class="monthly-display">$0.00</span>
          </div>`;
        empC.appendChild(card);

        const pt = card.querySelector('.pay-type-select');
        pt.onchange = () => {
          card.querySelector('.hourly-group').style.display = pt.value === 'hourly' ? 'block' : 'none';
          card.querySelector('.salary-group').style.display = pt.value === 'salary' ? 'block' : 'none';
          updateTotals();
        };

        if (emp === maxE) addE.disabled = true;
      };
      addE.click();

      // Other income
      addO.onclick = () => {
        oth++;
        const r = document.createElement('div');
        r.className = 'form-row';
        r.innerHTML = `
          <select class="other-income-type">
            <option>Social Security</option>
            <option>Retirement</option>
            <option>Disability</option>
            <option>Alimony</option>
            <option>Other Income</option>
          </select>
          <input type="number" class="other-income-input" placeholder="Monthly Amount" min="0" step="0.01">`;
        othC.appendChild(r);
      };
      addO.click();

      // Expenses logic unchanged‚Ä¶
      const expC = document.getElementById('expenses-container'),
            addX = document.getElementById('add-expense-btn'),
            selX = document.getElementById('expense-selector'),
            tX   = document.getElementById('expense-type-select'),
            cX   = document.getElementById('expense-type-confirm-btn');
      const cnt = {car:0, credit:0, loan:0, 'child-support':0, 'medical-bills':0},
            lim = {car:2, credit:10, loan:10, 'child-support':10, 'medical-bills':10};
      function addStat(l,id){
        const cd=document.createElement('div');cd.className='card';
        cd.innerHTML=`
          <div class="section-title">${l}</div>
          <div class="form-row"><label>Amount:</label><input type="number" id="${id}-input" class="expense-input" placeholder="Monthly ${l}" min="0" step="0.01"></div>`;
        expC.appendChild(cd);
      }
      function addDyn(t){
        if(cnt[t]>=lim[t]) return; cnt[t]++;
        let lbl;
        switch(t){
          case 'car': lbl='Car Payment'; break;
          case 'credit': lbl='Credit Card'; break;
          case 'loan': lbl='Loan'; break;
          case 'child-support': lbl='Child Support'; break;
          default: lbl='Medical Bills';
        }
        const cd=document.createElement('div');cd.className='card';
        cd.innerHTML=`
          <div class="section-title">${lbl} ${cnt[t]}</div>
          <div class="form-row"><label>Amount:</label><input type="number" class="expense-input" placeholder="Monthly ${lbl}" min="0" step="0.01"></div>`;
        expC.appendChild(cd);
        if(cnt[t]===lim[t]) tX.querySelector(`option[value="${t}"]`).disabled=true;
      }
      addStat('Rent','rent');
      addDyn('car');
      addDyn('credit');
      addDyn('loan');
      addX.onclick = () => selX.style.display = 'flex';
      cX.onclick = () => { addDyn(tX.value); selX.style.display='none'; };

      // Elements for totals and chart
      const tiEl = document.getElementById('total-income'),
            teEl = document.getElementById('total-expenses'),
            eInc = document.getElementById('eq-income'),
            eExp = document.getElementById('eq-exp'),
            eDisp= document.getElementById('eq-disp'),
            budH = document.getElementById('budget-health'),
            copyB= document.getElementById('copy-btn'),
            mtIn = document.getElementById('mortgage-input'),
            chkB = document.getElementById('check-afford-btn'),
            cnv  = document.getElementById('breakdown-chart'),
            lg   = document.getElementById('chart-legend'),
            exEl = document.getElementById('affordability-explanation'),
            rEl  = document.getElementById('affordability-result'),
            ctx  = cnv.getContext('2d');

      // Updated to handle hourly & salary per card
      function updateTotals(){
        let ti = 0;
        document.querySelectorAll('#employers-container .card').forEach(card => {
          let m = 0;
          const hr = card.querySelector('.hourly-rate'),
                sl = card.querySelector('.yearly-salary');
          if(hr){
            const rate = hr.valueAsNumber||0,
                  hrs  = card.querySelector('.hours-per-week').valueAsNumber||0;
            m = rate * hrs * 52/12;
          } else if(sl){
            const yearly = sl.valueAsNumber||0;
            m = yearly / 12;
          }
          ti += m;
          card.querySelector('.monthly-display').textContent = '$' + fmt(m);
        });

        let othSum = 0;
        document.querySelectorAll('.other-income-input').forEach(i => othSum += i.valueAsNumber||0);
        ti += othSum;
        tiEl.textContent = '$' + fmt(ti);

        let te = 0;
        document.querySelectorAll('.expense-input').forEach(i => te += i.valueAsNumber||0);
        teEl.textContent = '$' + fmt(te);

        const disp = ti - te;
        eInc.textContent = '$' + fmt(ti);
        eExp.textContent = '$' + fmt(te);
        eDisp.textContent = '$' + fmt(disp);
        eDisp.style.color = disp < 600 ? varGet('--red') : varGet('--green');

        budH.textContent = disp < 600
          ? '‚ö†Ô∏è Your disposable income is under $600‚Ää/month. Consider reducing debts or raising income.'
          : '';

        return { ti, te, disp };
      }

      copyB.onclick = () => {
        const txt = `Income ${eInc.textContent}\nExpenses ${eExp.textContent}\nDisposable ${eDisp.textContent}`;
        navigator.clipboard.writeText(txt);
        copyB.textContent = '‚úÖ Copied!';
        copyB.disabled = true;
        setTimeout(() => {
          copyB.textContent = 'üìã Copy for reference';
          copyB.disabled = false;
        }, 2000);
      };

      function drawChart(r, e, s, mtg){
        const data = [r, e, s].map(v => Math.max(v, 0)),
              total = data.reduce((a, b) => a + b, 0),
              cols = [varGet('--red'), varGet('--yellow'), varGet('--green')],
              labs = ['Rent','Toward Mortgage','Leftover'];
        ctx.clearRect(0, 0, 240, 240);
        lg.innerHTML = '';
        if(!total) return;
        let start = -0.5 * Math.PI,
            cx = 120, cy = 120, rad = 100;
        ctx.lineWidth = 24;
        data.forEach((v,i) => {
          const slice = v/total * 2 * Math.PI;
          ctx.beginPath();
          ctx.strokeStyle = cols[i];
          ctx.arc(cx, cy, rad, start, start+slice);
          ctx.stroke();
          const pct = (v/total * 100).toFixed(0);
          const li = document.createElement('li');
          li.innerHTML = `<span class="dot" style="background:${cols[i]}"></span>
                          ${labs[i]} $${fmt(v)} (${pct}%)`;
          lg.appendChild(li);
          start += slice;
        });
        ctx.fillStyle = varGet('--navy');
        ctx.textAlign = 'center';
        ctx.font = '600 16px Lato';
        ctx.fillText('Monthly', cx, cy-8);
        ctx.fillText('Mortgage', cx, cy+8);
        ctx.font = '700 18px Playfair Display';
        ctx.fillText(`$${fmt(mtg)}`, cx, cy+32);
      }

      chkB.onclick = () => {
        const { ti, te, disp } = updateTotals(),
              mortgage = mtIn.valueAsNumber || 0,
              rentVal = parseFloat(document.getElementById('rent-input').value) || 0,
              needed = Math.max(mortgage - rentVal, 0),
              spare = disp - needed,
              cl = Math.max(spare, 0),
              shortBy = Math.abs(Math.min(spare, 0));

        drawChart(rentVal, needed, cl, mortgage);

        if (spare < 0) {
          exEl.innerHTML = `
            <p>You can‚Äôt cover a <span class="toward">$${fmt(mortgage)}</span> mortgage.</p>
            <p>You‚Äôre short <span class="shortfall">$${fmt(shortBy)}</span> per month.</p>`;
          rEl.textContent = '‚ö†Ô∏è Not enough income to afford this payment.';
          rEl.style.color = varGet('--red');
        } else if (spare < 600) {
          exEl.innerHTML = `
            <p>You already pay <span class="rent">$${fmt(rentVal)}</span> in rent.</p>
            <p>A <span class="toward">$${fmt(mortgage)}</span> mortgage uses <span class="toward">$${fmt(needed)}</span> of your disposable income.</p>
            <p>That leaves <span class="shortfall">$${fmt(spare)}</span> to spare.</p>`;
          rEl.textContent = '‚ö†Ô∏è Warning: budget is tight‚Äîconsider reducing debts or boosting income.';
          rEl.style.color = varGet('--red');
        } else {
          exEl.innerHTML = `
            <p>You already pay <span class="rent">$${fmt(rentVal)}</span> in rent.</p>
            <p>A <span class="toward">$${fmt(mortgage)}</span> mortgage uses <span class="toward">$${fmt(needed)}</span> of your disposable income.</p>
            <p>That leaves <span class="leftover">$${fmt(spare)}</span> to spare.</p>`;
          rEl.textContent = '‚úÖ You could afford this payment!';
          rEl.style.color = varGet('--green');
        }

        window.parent.postMessage({
          action: 'save',
          data: { income: ti, expenses: te, disposable: disp, targetMortgage: mortgage }
        }, '*');
      };

      document.body.addEventListener('input', () => {
        if (cur < 2) updateTotals();
      });
      updateTotals();
    });
  </script>
</body>
</html>